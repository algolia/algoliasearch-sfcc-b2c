version: 2.1

orbs:
  node: circleci/node@6.1.0
  cypress: cypress-io/cypress@3

aliases:
  - &persist_work_dir
    root: .
    paths:
      - .
  - &attach_work_dir
    at: .
  - &node_executor
    name: node/default
    tag: '18.18.0'
  - &install_sfcc_ci
    run:
      name: Install sfcc-ci
      command: sudo npm install -g sfcc-ci
  
  - &authenticate_sfcc
    run:
      name: Authenticate with SFCC
      command: |
        sfcc-ci client:auth "$SFCC_OAUTH_CLIENT_ID" "$SFCC_OAUTH_CLIENT_SECRET"
        echo "export ACCESS_TOKEN=$(sfcc-ci client:auth:token)" >> $BASH_ENV

jobs:
  test:
    executor: *node_executor
    steps:
      - checkout
      - run: npm ci
      - run: npm run test:unit

  index-tests:
    executor: *node_executor
    steps:
      - checkout
      - *install_sfcc_ci
      - *authenticate_sfcc
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Install Algolia Dependencies
          command: npm install algoliasearch
      - run:
          name: Run Algolia Index Tests
          command: npm test -- test/e2e/variation_index.test.js

  e2e-tests:
    executor: cypress/default
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: npm ci
      - run:
          name: Run Cypress Tests
          command: npx cypress run --browser electron --headless --config-file cypress.config.js

workflows:
  suite:
    jobs:
      - test
      - index-tests
      - e2e-tests:
          requires:
            - index-tests
