<?xml version="1.0" encoding="UTF-8"?>
<jobs xmlns="http://www.demandware.com/xml/impex/jobs/2015-07-01">
    <job job-id="AlgoliaProductsIndex" priority="0">
        <description>Export products to Algolia service for update search index files</description>
        <parameters/>
        <flow>
            <context site-id="RefArch"/>
            <step step-id="calculateProductsDelta" type="ExecuteScriptModule" enforce-restart="false">
                <description/>
                <parameters>
                    <parameter name="ExecuteScriptModule.Module">int_algolia/cartridge/scripts/algolia/job/productsIndexJob.js</parameter>
                    <parameter name="ExecuteScriptModule.FunctionName">execute</parameter>
                    <parameter name="ExecuteScriptModule.Transactional">false</parameter>
                    <parameter name="clearAndRebuild">false</parameter>
                </parameters>
            </step>
            <step step-id="sendProductsDelta" type="ExecuteScriptModule" enforce-restart="false">
                <description/>
                <parameters>
                    <parameter name="ExecuteScriptModule.Module">int_algolia/cartridge/scripts/algolia/job/sendProductsDelta.js</parameter>
                    <parameter name="ExecuteScriptModule.FunctionName">execute</parameter>
                    <parameter name="ExecuteScriptModule.Transactional">false</parameter>
                </parameters>
            </step>
        </flow>
        <rules/>
        <triggers>
            <run-once enabled="false">
                <date>2020-04-03Z</date>
                <time>11:58:28.000Z</time>
            </run-once>
        </triggers>
    </job>

    <job job-id="AlgoliaCategoriesIndex" priority="0">
        <description>Export categories to Algolia service for update search index files</description>
        <parameters/>
        <flow>
            <context site-id="RefArch"/>
            <step step-id="calculateÐ¡ategoriesDelta" type="ExecuteScriptModule" enforce-restart="false">
                <description/>
                <parameters>
                    <parameter name="ExecuteScriptModule.Module">int_algolia/cartridge/scripts/algolia/job/categoryIndexJob.js</parameter>
                    <parameter name="ExecuteScriptModule.FunctionName">execute</parameter>
                    <parameter name="ExecuteScriptModule.Transactional">false</parameter>
                    <parameter name="clearAndRebuild">false</parameter>
                </parameters>
            </step>
            <step step-id="sendCategoriesDelta" type="ExecuteScriptModule" enforce-restart="false">
                <description/>
                <parameters>
                    <parameter name="ExecuteScriptModule.Module">int_algolia/cartridge/scripts/algolia/job/sendCategoriesDelta.js</parameter>
                    <parameter name="ExecuteScriptModule.FunctionName">execute</parameter>
                    <parameter name="ExecuteScriptModule.Transactional">false</parameter>
                </parameters>
            </step>
        </flow>
        <rules/>
        <triggers>
            <run-once enabled="false">
                <date>2020-04-15Z</date>
                <time>07:48:46.000Z</time>
            </run-once>
        </triggers>
    </job>

    <job job-id="AlgoliaProductsDeltaExport" priority="0">
        <description>This is an alternative to the current delta calculation and sending method which calculates the delta export file by comparing the last full export to the current one, possibly comparing two huge XML files.
This method relies on SFCC's built-in Delta Exports feature to calculate the delta (omitting the delta calculation phase completely and speeding up the process considerably), then enriches and transforms the products before sending them to Algolia for indexing.
Make sure to contact SFCC Support to enable delta exports on your instance.</description>
        <parameters>
            <parameter name="exportFile">productDeltaExport</parameter>
            <parameter name="consumers">algolia</parameter>
            <parameter name="catalogIDs">apparel-catalog, apparel-m-catalog</parameter>
        </parameters>
        <flow>
            <context site-id="RefArch"/>
            <step step-id="catalogDeltaExport" type="CatalogDeltaExport" enforce-restart="false">
                <description/>
                <parameters>
                    <parameter name="CatalogIDs" job-parameter-ref="catalogIDs"/>
                    <parameter name="Consumers" job-parameter-ref="consumers"/>
                    <parameter name="ExportFile" job-parameter-ref="exportFile"/>
                    <parameter name="MasterProductExport">false</parameter>
                </parameters>
                <rules>
                    <on-exit status="ERROR">
                        <stop-job/>
                    </on-exit>
                </rules>
            </step>
            <step step-id="sendDeltaExportProducts" type="custom.algoliaSendDeltaExportProducts" enforce-restart="false">
                <description/>
                <parameters>
                    <parameter name="consumers" job-parameter-ref="consumers"/>
                    <parameter name="exportFile" job-parameter-ref="exportFile"/>
                </parameters>
            </step>
        </flow>
        <rules>
            <on-running runtime-threshold="60m" enabled="false">
                <mark-job-as-hanging/>
            </on-running>
        </rules>
        <triggers>
            <run-once enabled="false">
                <date>2023-06-13Z</date>
                <time>21:00:00.000Z</time>
            </run-once>
        </triggers>
    </job>
</jobs>
